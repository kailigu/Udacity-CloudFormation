# CloudFormation Script
# Project: UdacityProject2
# Created by: Sasho Petrovski

# Network architecture script.
Description:
  < Sasho Petrovski
  Udacity Project 2

Parameters:
  EnvironmentName:
    Description: An environment name that will be prefixed to resource names.
    Type: String
    
  ProjectName:
    Description: The project name you're working on.
    Type: String
  
  VpcCIDR: 
    Description: Please enter the IP range (CIDR notation) for this VPC
    Type: String

  PublicSubnet1CIDR:
    Description: IP range (CIDR notation) for the public subnet in the first availability zone.
    Type: String

  PublicSubnet2CIDR:
    Description: IP range (CIDR notation) for the public subnet in the first availability zone.
    Type: String

  

    


Resources:

  # Network Architecture
 
  # Virtual Private Cloud
  VPC: 
      Type: AWS::EC2::VPC 
      Properties:
          CidrBlock: !Ref VpcCIDR # References the params.json file
          EnableDnsHostnames: true
          Tags: 
              - 
                Key: ProjectName
                Value: !Ref ProjectName
              - 
                Key: EntityName
                Value: Virtual Private Cloud
              -
                Key: EntityType
                Value: Virtual Private Cloud
              

  # Allows outside connection to your VPC
  # Allows inbound and outbound traffic from the outside world into your Private Cloud.
  InternetGateway:
      Type: AWS::EC2::InternetGateway
      Properties:
          Tags:
              - 
                Key: ProjectName
                Value: !Ref ProjectName

# Internet Gateway
  # It's important to note when connecting an Internet Gateway to a VPC, 
  # we need to define an additional resource called InternetGatewayAttachment. 
  # This attachment references both the VPC and the InternetGateway.            
  InternetGatewayAttachment:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
          InternetGatewayId: !Ref InternetGateway
          VpcId: !Ref VPC
          

  # Public Subnet 1
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
        VpcId: !Ref VPC
        CidrBlock: !Ref PublicSubnet1CIDR
        MapPublicIpOnLaunch: true
        Tags:
          - 
            Key: ProjectName
            Value: UdacityProject2
          - 
            Key: EntityName
            Value: PublicSubnet1
          -
            Key: EntityType
            Value: Subnet
          -
            Key: EntityAttribute
            Value: Public
        
  
  # Public Subnet 2 
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
        VpcId: !Ref VPC
        CidrBlock: !Ref PublicSubnet2CIDR
        MapPublicIpOnLaunch: true
        Tags:
          - 
            Key: ProjectName
            Value: UdacityProject2
          - 
            Key: EntityName
            Value: PublicSubnet2
          -
            Key: EntityType
            Value: Subnet
          -
            Key: EntityAttribute
            Value: Public

 # Route Tables

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties: 
        VpcId: !Ref VPC
        Tags: 
            - Key: ProjectName 
              Value: !Ref ProjectName
            - Key: EntityType
              Value: RouteTable  

  # Route to gateway 
  DefaultPublicRoute: 
    Type: AWS::EC2::Route
    Properties: 
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway

  # Associate Public Subnet 1 to the Route Table
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet1
  
  # Associate Public Subnet 2 to the Route Table
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet2

  # Security group for EC2 Instance.      
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties: 
      GroupDescription: EC2 Security Group
      GroupName: EC2-SecurityGroup
      VpcId: !Ref VPC
      # Outbound Rules
      SecurityGroupEgress: 
      - IpProtocol: TCP
        FromPort: 0
        ToPort: 65535 
        CidrIp: 0.0.0.0/0
      # Inbound Rules  
      SecurityGroupIngress: 
      - IpProtocol: TCP
        FromPort: 22
        ToPort: 22  
        CidrIp: 0.0.0.0/0 # Should specifiy the specific IP address.
      Tags: 
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: EntityType
          Value: SecurityGroup

Outputs:
  VPC: 
    Description: A reference to the created VPC
    Value: !Ref VPC
    Export:
      Name: !Sub ${EnvironmentName}-VPCID          

  PublicSubnets:
    Description: A list of the public subnet IDs
    Value: !Join [ ",", [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]]
    Export:
      Name: !Sub ${EnvironmentName}-Public-Subnet-IDs
  
  PublicSubnetCIDRs:
    Description: A list of the public subnet CIDRs
    Value: !Join [ ",", [ !Ref PublicSubnet1CIDR, !Ref PublicSubnet2CIDR ]]
    Export:
      Name: !Sub ${EnvironmentName}-Public-Subnet-CIDRs

  WebServerSecurityGroup:
    Description: Security group to be attached to an EC2 Instance.
    Value: !Ref WebServerSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-WebSecurityGroupID
    